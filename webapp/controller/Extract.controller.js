sap.ui.define(["sap/ui/core/mvc/Controller",
	"sap/m/MessageBox",
], function (Controller, MessageBox) {
	"use strict";
	return Controller.extend("cognitivepp.CognitiveApp.controller.Extract", {
		/**
		 * Called when a controller is instantiated and its View controls (if available) are already created.
		 * Can be used to modify the View before it is displayed, to bind event handlers and do other one-time initialization.
		 * @memberOf cognitivepp.CognitiveApp.view.Extract
		 */
		onInit: function () {

			/*		var extModel = new sap.ui.model.json.JSONModel("./data/data1.json");
					var oTable = this.byId("extracttable");
					oTable.setModel(extModel);
					*/

			//			var lvvendor = this.byId("idvendorsearch");
			var lvstatus = "Uploaded";

			var lv_where = "filter[where][and][0][invoicestatus]=" + lvstatus;

			var sUrl_list = "http://localhost:3000/invoicefiles?" + lv_where;
			jQuery.ajax({
				type: "GET",
				//			dataType: "xml",
				dataType: "json",
				data: {},
				url: sUrl_list,
				context: this,
				crossDomain: true,
				error: function (jqXHR, textStatus, errorThrown) {
					var sMessage = jqXHR.status + " " + jqXHR.statusText + " " + jqXHR.responseText;
					jQuery.sap.log.error("Data loading error", sMessage, "index.html");
					sap.m.MessageBox.show(JSON.parse(jqXHR.responseText).error.message);
				},
				success: function (oData, status, jqXHR) {
					if (oData === null || oData === undefined) {
						var sMessage = "WARNING. Received a null or undefined response object.";
						jQuery.sap.log.warning("Data loading messageiungasd", sMessage, "index.html");
						sap.m.MessageToast.show(sMessage);
						return;
					} else

					//			    var oXMLModel = new sap.ui.model.xml.XMLModel(oData);
						var invuploadstatus = new sap.ui.model.json.JSONModel(oData);
					//		    var oTable = this.byId("mTable");
					//					this.getView().setModel(invuploadstatus);
					var oSelect = this.byId("selectfile");
					oSelect.setModel(invuploadstatus);
				}
			});

		},
		
		OnRefresh: function(oEvent){
			
			var lvstatus = "Uploaded";
			var lv_where = "filter[where][and][0][invoicestatus]=" + lvstatus;

			var sUrl_list = "http://localhost:3000/invoicefiles?" + lv_where;
			jQuery.ajax({
				type: "GET",
				//			dataType: "xml",
				dataType: "json",
				data: {},
				url: sUrl_list,
				context: this,
				crossDomain: true,
				error: function (jqXHR, textStatus, errorThrown) {
					var sMessage = jqXHR.status + " " + jqXHR.statusText + " " + jqXHR.responseText;
					jQuery.sap.log.error("Data loading error", sMessage, "index.html");
					sap.m.MessageBox.show(JSON.parse(jqXHR.responseText).error.message);
				},
				success: function (oData, status, jqXHR) {
					if (oData === null || oData === undefined) {
						var sMessage = "WARNING. Received a null or undefined response object.";
						jQuery.sap.log.warning("Data loading messageiungasd", sMessage, "index.html");
						sap.m.MessageToast.show(sMessage);
						return;
					} else

					//			    var oXMLModel = new sap.ui.model.xml.XMLModel(oData);
						var invuploadstatus = new sap.ui.model.json.JSONModel(oData);
					//		    var oTable = this.byId("mTable");
					//					this.getView().setModel(invuploadstatus);
					var oSelect = this.byId("selectfile");
					oSelect.setModel(invuploadstatus);
				}
			});

			
		},
		/**
		 *@memberOf cognitivepp.CognitiveApp.controller.Extract
		 */
		OnExtract: function (oEvent) {
			//This code was generated by the layout editor.
			var that = this;

			var oGlobalBusyDialog = new sap.m.BusyDialog();
			oGlobalBusyDialog.open();
			var filename = this.byId("selectfile");

			var filename_val = filename.getSelectedItem().getKey();
			var filename_ext = JSON.stringify({
				"filename": filename_val
			});
			var sUrl2 = "http://localhost:8081/extract/";
			jQuery.ajax({
				type: "POST",
				url: sUrl2,
				data: filename_ext,
				contentType: "application/json",
				dataType: "json",
				error: function (jqXHR, textStatus, errorThrown) {
					var sMessage = jqXHR.status + " " + jqXHR.statusText + " " + jqXHR.responseText;
					jQuery.sap.log.error("Data loading error", sMessage, "index.html");
					sap.m.MessageBox.show(JSON.parse(jqXHR.responseText).error.message);
				},
				success: function (oData, status, jqXHR) {
					if (oData === null || oData === undefined) {
						var sMessage = "WARNING. Received a null or undefined response object.";
						jQuery.sap.log.warning("Data loading messageiungasd", sMessage, "index.html");
						sap.m.MessageToast.show(sMessage);
						oGlobalBusyDialog.close();
						return;
					}
					var extModel = new sap.ui.model.json.JSONModel(oData);
					var oTable = that.byId("extracttable");
					oTable.setModel(extModel);

					var extract = [{
						filename: String,
						contenttype: String,
						contentname: String,
						contentvalue: String
					}];

					extract.pop();
					oData.forEach(function (rowdata) {
						extract.push({
							filename: filename_val,
							contenttype: rowdata.rowid,
							contentname: rowdata.name,
							contentvalue: rowdata.content1
						});
					});

					var contentd = JSON.stringify(extract);

					//			var contentd = JSON.stringify(oData);

					sUrl2 = "http://localhost:3000/invoiceextracts/";
					jQuery.ajax({
						type: "POST",
						url: sUrl2,
						data: contentd,
						contentType: "application/json",
						dataType: "json",
						error: function (jqXHR, textStatus, errorThrown) {
							sap.m.MessageBox.show(JSON.parse(jqXHR.responseText).error.message);
						},
						success: function (oData, status, jqXHR) {
							if (oData === null || oData === undefined) {
								var sMessage = "WARNING. Received a null or undefined response object.";
								jQuery.sap.log.warning("Data loading messageiungasd", sMessage, "index.html");
								sap.m.MessageToast.show(sMessage);
								oGlobalBusyDialog.close();
								return;
							}
						}
					});

					var lv_where = "filter[where][and][0][fileurl]=" + filename_val;

					var sUrl_list = "http://localhost:3000/invoicefiles?" + lv_where;
					jQuery.ajax({
						type: "GET",
						//			dataType: "xml",
						dataType: "json",
						data: {},
						url: sUrl_list,
						context: this,
						crossDomain: true,
						error: function (jqXHR, textStatus, errorThrown) {
							var sMessage = jqXHR.status + " " + jqXHR.statusText + " " + jqXHR.responseText;
							jQuery.sap.log.error("Data loading error", sMessage, "index.html");
							sap.m.MessageBox.show(JSON.parse(jqXHR.responseText).error.message);
						},
						success: function (oData, status, jqXHR) {

							var rowval;
							var rowcomments;
							var rowdate; 
							oData.forEach(function (rowdata) { 
								rowval = rowdata.id;
								rowcomments = rowdata.comments + "; Extraction Completed";
							});
							var today = new Date();
							var lvcreatedate = today;
							var statusupd = JSON.stringify({
								"invoicestatus": "Extracted",
								"extractdate" : lvcreatedate,
								"comments" : rowcomments
							});

							var sUrl_list = "http://localhost:3000/invoicefiles/" + rowval;

							jQuery.ajax({
								type: "PATCH",
								url: sUrl_list,
								data: statusupd,
								contentType: "application/json",
								dataType: "json",
								error: function (jqXHR, textStatus, errorThrown) {
									sap.m.MessageBox.show(JSON.parse(jqXHR.responseText).error.message);
								},
								success: function (oData, status, jqXHR) {
									
								}
							});
							oGlobalBusyDialog.close();

						}
					});

				}

			});

		}
	});
});